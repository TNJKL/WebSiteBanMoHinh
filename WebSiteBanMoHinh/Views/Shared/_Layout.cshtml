@using WebSiteBanMoHinh.Repository
@using WebSiteBanMoHinh.Resources;
@inject LanguageService ShareLocallizer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@inject UserManager<AppUserModel> UserManager
@inject DataContext _context
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Home | E-Shopper</title>
    <link href="~/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
    <link href="~/css/prettyPhoto.css" rel="stylesheet">
    <link href="~/css/price-range.css" rel="stylesheet">
    <link href="~/css/animate.css" rel="stylesheet">
    <link href="~/css/main.css" rel="stylesheet">
    <link href="~/css/responsive.css" rel="stylesheet">
    <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
    <script src="js/respond.min.js"></script>
    <![endif]-->
    <link rel="shortcut icon" href="images/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="images/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="images/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="images/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="images/ico/apple-touch-icon-57-precomposed.png">

    <div id="fb-root"></div>
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v22.0"></script>
</head><!--/head-->

<body>
    <header id="header">
        <!--header-->
        <div class="header_top">
            <!--header_top-->
            <div class="container">
                <div class="row">
                    <div class="col-sm-6">
                        <div class="contactinfo">
                            <ul class="nav nav-pills">
                                <li><a href="#"><i class="fa fa-phone"></i> +2 95 01 88 821</a></li>
                                <li><a href="#"><i class="fa fa-envelope"></i> info@domain.com</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="social-icons pull-right">
                            <ul class="nav navbar-nav">
                                <li><a href="#"><i class="fa fa-facebook"></i></a></li>
                                <li><a href="#"><i class="fa fa-twitter"></i></a></li>
                                <li><a href="#"><i class="fa fa-linkedin"></i></a></li>
                                <li><a href="#"><i class="fa fa-dribbble"></i></a></li>
                                <li><a href="#"><i class="fa fa-google-plus"></i></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div><!--/header_top-->

        <div class="header-middle">
            <!--header-middle-->
            <div class="container">
                <div class="row">
                    <div class="col-sm-4">
                        <div class="logo pull-left">
                            <a href="index.html"><img src="images/home/logo.png" alt="" /></a>
                        </div>
                        <div class="btn-group pull-right">
                            <div class="btn-group">
                                <button type="button" class="btn btn-default dropdown-toggle usa" data-toggle="dropdown">
                                    @ShareLocallizer.GetLocalizedHTML("Language")
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a asp-controller="Home" asp-action="ChangeLang" asp-route-culture="vi-VN">VN</a></li>
                                    <li><a asp-controller="Home" asp-action="ChangeLang" asp-route-culture="en-US">EN</a></li>
                                </ul>
                            </div>


                        </div>
                    </div>
                    <div class="col-sm-8">
                        <div class="shop-menu pull-right">
                            <ul class="nav navbar-nav">


                                <li><a href="cart.html"><i class="fa fa-shopping-cart"></i> @ShareLocallizer.GetLocalizedHTML("Cart")</a></li>
                                @if (User.Identity?.IsAuthenticated ?? false)
                                {
                                    <li><a asp-controller="Account" asp-action="Logout"><i class="fa fa-lock"></i> Hi, @User.Identity.Name, @ShareLocallizer.GetLocalizedHTML("Logout")</a></li>

                                    @if (User.Identity.IsAuthenticated && User.IsInRole("ADMIN"))
                                    {
                                        <li>
                                            <a asp-area="Admin" asp-controller="Product" asp-action="Index">
                                                <i class="fa fa-crosshairs"></i> Admin
                                            </a>
                                        </li>

                                    }
                                    @if (User.Identity.IsAuthenticated && User.IsInRole("CSKH"))
                                    {
                                        <li>
                                            <a asp-controller="Messages" asp-action="Messages">
                                                <i class="fa fa-crosshairs"></i> CSKH
                                            </a>
                                        </li>

                                    }
                                    @if(User.Identity?.IsAuthenticated ?? false)
                                    {
                                        <li><a asp-action="Wishlist" asp-controller="Home"><i class="fa fa-star"></i> Wishlist</a></li>
                                        <li><a asp-action="Compare" asp-controller="Home"><i class="fa fa-star"></i> Compare</a></li>
                                    }
                                    <li class="dropdown">
                                        <a style="cursor:pointer" class="dropdown-toggle" data-toggle="dropdown" >
                                            <i class="fa fa-user"></i> Account <span class="caret"></span>
                                            </a>
                                        <ul class="dropdown-menu">
                                            <li><a asp-action="History" asp-controller="Account" >History Orders</a></li>
                                            <li><a asp-action="UpdateAccount" asp-controller="Account">Update Information</a></li>
                                         
                                        </ul>
                                    </li>

                                }

                                else
                                {
                                    <li><a asp-controller="Account" asp-action="Login"><i class="fa fa-lock"></i>@ShareLocallizer.GetLocalizedHTML("Login")</a></li>
                                }

                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div><!--/header-middle-->

        <div class="header-bottom">
            <!--header-bottom-->
            <div class="container">
                <div class="row">
                    <div class="col-sm-9">
                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                                <span class="sr-only">Toggle navigation</span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
                        </div>
                        <div class="mainmenu pull-left">
                            <ul class="nav navbar-nav collapse navbar-collapse">
                                <li><a asp-controller="Home" class="active">@ShareLocallizer.GetLocalizedHTML("Home")</a></li>
                                <li class="dropdown">
                                    <a asp-controller="Product">@ShareLocallizer.GetLocalizedHTML("Shop")<i class="fa fa-angle-down"></i></a>
                                    <ul role="menu" class="sub-menu">
                                        <li><a asp-controller="Category" asp-action="Index">Categories</a></li>
                                        <li><a asp-action="Details" asp-controller="Product">Product Details</a></li>
                                        <li><a asp-action="Checkout" asp-controller="Cart">Checkout</a></li>
                                        <li><a asp-action="Index" asp-controller="Cart">Cart</a></li>

                                    </ul>
                                </li>
                                <li class="dropdown">
                                    <a href="#">Blog<i class="fa fa-angle-down"></i></a>
                                    <ul role="menu" class="sub-menu">
                                        <li><a href="blog.html">Blog List</a></li>
                                        <li><a href="blog-single.html">Blog Single</a></li>
                                    </ul>
                                </li>
                                <li><a href="404.html">404</a></li>
                                <li><a asp-controller="Home" asp-action="Contact" >Contact</a></li>
                            </ul>
                        </div>
                    </div>
                   @* <div class="col-sm-3">
                        <form asp-controller="Product" asp-action="Search" method="post">
                            <div class="search_box pull-right">
                                <input type="text" placeholder="@ShareLocallizer.GetLocalizedHTML("Search")" name="searchTerm" />
                                <button class="btn btn-warning" type="submit">@ShareLocallizer.GetLocalizedHTML("Search")</button>                               
                            </div>
                        </form>
                    </div>
                    *@
                    <div class="col-sm-3">
                        <form asp-controller="Product" asp-action="Search" method="get">
                            <div class="search_box pull-right">
                                <input type="text" id="searchBox" name="searchTerm" class="form-control" placeholder="@ShareLocallizer.GetLocalizedHTML("Search")" />

                                <div class="input-group">
                                    <!-- Nút tìm kiếm thông thường -->
                                    <button class="btn btn-warning" type="submit">@ShareLocallizer.GetLocalizedHTML("Search")</button>

                                    <!-- Nút tìm kiếm bằng giọng nói -->
                                    <button id="voiceSearchBtn" type="button" class="btn btn-primary">
                                        <i class="fa fa-microphone"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    @*ti xoa phan nay*@

                    @*<form asp-action="Search" asp-controller="Product" method="get" class="input-group">
                        <input type="text" id="searchBox" name="searchTerm" class="form-control" placeholder="Tìm kiếm sản phẩm..." />
                        <button id="voiceSearchBtn" type="button" class="btn btn-primary">
                            <i class="fa fa-microphone"></i>
                        </button>
                    </form>
                    *@
                    </div>@*ti xoa phan nay*@

                </div>
            </div>
        </div><!--/header-bottom-->
    </header><!--/header-->

    

    <section>
        <div class="container">
            <div class="row">
                @Html.Partial("_NotificationPartial")
                @RenderBody()
            </div>
        </div>
    </section>

    <footer id="footer">
        <!--Footer-->
        @Html.Partial("_FooterPartial")

        @* <div class="footer-widget">
            <div class="container">
                <div class="row">
                    <div class="col-sm-2">
                        <div class="single-widget">
                            <h2>Service</h2>
                            <ul class="nav nav-pills nav-stacked">
                                <li><a href="#">Online Help</a></li>
                                <li><a href="#">Contact Us</a></li>
                                <li><a href="#">Order Status</a></li>
                                <li><a href="#">Change Location</a></li>
                                <li><a href="#">FAQ’s</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <div class="single-widget">
                            <h2>Quock Shop</h2>
                            <ul class="nav nav-pills nav-stacked">
                                <li><a href="#">T-Shirt</a></li>
                                <li><a href="#">Mens</a></li>
                                <li><a href="#">Womens</a></li>
                                <li><a href="#">Gift Cards</a></li>
                                <li><a href="#">Shoes</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <div class="single-widget">
                            <h2>Policies</h2>
                            <ul class="nav nav-pills nav-stacked">
                                <li><a href="#">Terms of Use</a></li>
                                <li><a href="#">Privecy Policy</a></li>
                                <li><a href="#">Refund Policy</a></li>
                                <li><a href="#">Billing System</a></li>
                                <li><a href="#">Ticket System</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <div class="single-widget">
                            <h2>About Shopper</h2>
                            <ul class="nav nav-pills nav-stacked">
                                <li><a href="#">Company Information</a></li>
                                <li><a href="#">Careers</a></li>
                                <li><a href="#">Store Location</a></li>
                                <li><a href="#">Affillate Program</a></li>
                                <li><a href="#">Copyright</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-sm-3 col-sm-offset-1">
                        <div class="single-widget">
                            <h2>About Shopper</h2>
                            <form action="#" class="searchform">
                                <input type="text" placeholder="Your email address" />
                                <button type="submit" class="btn btn-default"><i class="fa fa-arrow-circle-o-right"></i></button>
                                <p>Get the most recent updates from <br />our site and be updated your self...</p>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div> *@

        <div class="footer-bottom">
            <div class="container">
                <div class="row">
                    <p class="pull-left">Copyright © 2025 Lemon Shop Inc. All rights reserved.</p>
                    <p class="pull-right">Designed by <span><a target="_blank" href="http://www.themeum.com">Themeum</a></span></p>
                </div>
            </div>
        </div>
        
    </footer><!--/Footer-->



    <!--lỗi thì xóa :))-->
    @{
        var currentUser = await UserManager.GetUserAsync(User);
        var currentUserId = currentUser?.Id ?? "";
        string receiverId = "";
        string receiverUserName = "";

        if (User.IsInRole("CUSTOMER"))
        {
            // Khách hàng: mặc định chat với CSKH
            var cskhUser = await _context.Users.FirstOrDefaultAsync(u => u.UserName == "cskh");
            receiverId = cskhUser?.Id ?? "f207e978-52df-4d21-844f-b615034f4caf"; // Fallback nếu không tìm thấy
            receiverUserName = cskhUser?.UserName ?? "cskh";
        }
        else if (User.IsInRole("CSKH"))
        {
            // CSKH: lấy receiverId từ ViewData hoặc mặc định rỗng
            receiverId = ViewData["SelectedUserId"]?.ToString() ?? "";
            receiverUserName = ViewData["SelectedUserName"]?.ToString() ?? "Khách hàng";
        }

        var chatModel = new WebSiteBanMoHinh.ViewModels.CombinedMessagesViewModel
            {
                Chat = new WebSiteBanMoHinh.ViewModels.ChatViewModel
                {
                    CurrentUserId = currentUserId,
                    ReceiverId = receiverId,
                    ReceiverUserName = receiverUserName,
                    Messages = new List<WebSiteBanMoHinh.ViewModels.UserMessagesListViewModel>()
                }
            };
    }
    @if (User.IsInRole("CUSTOMER"))
       {
    @await Html.PartialAsync("_ChatWidget", chatModel)

    }
    <!--lỗi thì xóa :))-->








    <script src="~/js/jquery.js"></script>
    
    <script src="~/js/bootstrap.min.js"></script>
    <script src="~/js/jquery.scrollUp.min.js"></script>
    <script src="~/js/price-range.js"></script>
    <script src="~/js/jquery.prettyPhoto.js"></script>
    <script src="~/js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <!---Start TaggoAI--->
    <script async data-taggo-botid="67e56ff9e662d15a8e894693" src="https://widget.taggo.chat/v2.js"></script>
    <!---End TaggoAI--->
    @await RenderSectionAsync("Scripts", required: false)
    <script>
        window.fbAsyncInit = function() {
          FB.init({
            xfbml            : true,
            version          : 'v18.0'
          });
        };

        (function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = 'https://connect.facebook.net/vi_VN/sdk/xfbml.customerchat.js';
          fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>


    @*<script>
        document.addEventListener("DOMContentLoaded", function () {
            var voiceBtn = document.getElementById("voiceSearchBtn");
            var searchBox = document.getElementById("searchBox");

            if (voiceBtn && (window.SpeechRecognition || window.webkitSpeechRecognition)) {
                var recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'vi-VN';

                voiceBtn.addEventListener("click", function () {
                    try {
                        recognition.start();
                        console.log("🎤 Đang lắng nghe...");
                    } catch (err) {
                        console.error("Lỗi khi bắt đầu nhận diện giọng nói:", err);
                        alert("Không thể sử dụng tìm kiếm bằng giọng nói. Hãy kiểm tra quyền microphone!");
                    }
                });

                recognition.onresult = function (event) {
                    var searchTerm = event.results[0][0].transcript;
                    searchBox.value = searchTerm;
                    console.log("📢 Kết quả nhận diện:", searchTerm);

                    // Điều hướng đến Product/Search với searchTerm
                    var searchUrl = "/Product/Search?searchTerm=" + encodeURIComponent(searchTerm);
                    window.location.href = searchUrl;
                };

                recognition.onerror = function (event) {
                    console.error("Lỗi nhận diện:", event.error);
                    alert("Không thể nhận diện giọng nói: " + event.error);
                };
            } else {
                console.warn("Trình duyệt không hỗ trợ Speech Recognition.");
            }
        });
    </script>*@

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var voiceBtn = document.getElementById("voiceSearchBtn");
            var searchBox = document.getElementById("searchBox");
            var searchForm = searchBox.closest("form"); // Lấy form chứa input

            if (voiceBtn && (window.SpeechRecognition || window.webkitSpeechRecognition)) {
                var recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'vi-VN';

                voiceBtn.addEventListener("click", function () {
                    try {
                        recognition.start();
                        console.log("🎤 Đang lắng nghe...");
                    } catch (err) {
                        console.error("Lỗi khi bắt đầu nhận diện giọng nói:", err);
                        alert("Không thể sử dụng tìm kiếm bằng giọng nói. Hãy kiểm tra quyền microphone!");
                    }
                });

                recognition.onresult = function (event) {
                    var searchTerm = event.results[0][0].transcript;
                    searchBox.value = searchTerm;
                    console.log("📢 Kết quả nhận diện:", searchTerm);

                    // Tự động submit form sau khi nhận diện xong
                    searchForm.submit();
                };

                recognition.onerror = function (event) {
                    console.error("Lỗi nhận diện:", event.error);
                    alert("Không thể nhận diện giọng nói: " + event.error);
                };
            } else {
                console.warn("Trình duyệt không hỗ trợ Speech Recognition.");
            }
        });
    </script>
    
   
    
</body>
</html>

 @section Scripts{
    <partial name="_VoiceSearchScript" />
    <script>
        document.getElementById("voiceSearchBtn").addEventListener("click", function () {
            var recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'vi-VN';  // Cài đặt ngôn ngữ tiếng Việt
            recognition.start();

            recognition.onresult = function (event) {
                var searchTerm = event.results[0][0].transcript;
                document.getElementById("searchBox").value = searchTerm;
                window.location.href = '/Search?searchTerm=' + encodeURIComponent(searchTerm);
            };

            recognition.onerror = function (event) {
                alert("Không thể nhận diện giọng nói, vui lòng thử lại!");
            };
        });
    </script>
 }